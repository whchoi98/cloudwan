## Region
NRT - ap-northeast-1 
SYD - ap-southeast-2
FRA - eu-central-1
DUB - eu-west-1
IAD - us-east-1
PDX - us-west-2

### AWS Cli 2.0 Install

curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install

source ~/.bashrc
aws --version

which aws_completer
export PATH=/usr/local/bin:$PATH
source ~/.bash_profile
complete -C '/usr/local/bin/aws_completer' aws

### Session Manager Plugin
curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/linux_64bit/session-manager-plugin.rpm" -o "session-manager-plugin.rpm"
sudo sudo yum install -y session-manager-plugin.rpm

### util setup

sudo yum -y install jq gettext bash-completion moreutils
for command in kubectl jq envsubst aws
  do
    which $command &>/dev/null && echo "$command in path" || echo "$command NOT FOUND"
  done

### SSH Key
cd ~/environment/
ssh-keygen

cd ~/environment/
mv ./mykey ./mykey.pem
chmod 400 ./mykey.pem

## key export
cd ~/environment/
aws ec2 import-key-pair --key-name "mykey" --public-key-material fileb://./mykey.pub --region ap-northeast-1
aws ec2 import-key-pair --key-name "mykey" --public-key-material fileb://./mykey.pub --region ap-southeast-2
aws ec2 import-key-pair --key-name "mykey" --public-key-material fileb://./mykey.pub --region us-east-1
aws ec2 import-key-pair --key-name "mykey" --public-key-material fileb://./mykey.pub --region us-west-2
aws ec2 import-key-pair --key-name "mykey" --public-key-material fileb://./mykey.pub --region eu-central-1
aws ec2 import-key-pair --key-name "mykey" --public-key-material fileb://./mykey.pub --region eu-west-1

cd ~/environment
git clone https://github.com/whchoi98/cloudwan
git clone https://github.com/whchoi98/useful-shell.git

export KeyName=mykey
echo "export KeyName=${KeyName}" | tee -a ~/.bash_profile
source ~/.bash_profile

## NRT VPC
cd ./cloudwan
aws cloudformation deploy \
  --region ap-northeast-1 \
  --stack-name "NRT-VPC-Blue" \
  --template-file "/home/ec2-user/environment/cloudwan/NRT-VPC-Blue.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM &&
aws cloudformation deploy \
  --region ap-northeast-1 \
  --stack-name "NRT-VPC-Green" \
  --template-file "/home/ec2-user/environment/cloudwan/NRT-VPC-Green.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

## SYD VPC
cd ./cloudwan
aws cloudformation deploy \
  --region ap-southeast-2 \
  --stack-name "SYD-VPC-Blue" \
  --template-file "/home/ec2-user/environment/cloudwan/SYD-VPC-Blue.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM &&
aws cloudformation deploy \
  --region ap-southeast-2 \
  --stack-name "SYD-VPC-Green" \
  --template-file "/home/ec2-user/environment/cloudwan/SYD-VPC-Green.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

## IAD VPC
cd ./cloudwan
aws cloudformation deploy \
  --region us-east-1\
  --stack-name "IAD-VPC-Blue" \
  --template-file "/home/ec2-user/environment/cloudwan/IAD-VPC-Blue.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM &&   
aws cloudformation deploy \
  --region us-east-1 \
  --stack-name "IAD-VPC-Green" \
  --template-file "/home/ec2-user/environment/cloudwan/IAD-VPC-Green.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

## PDX VPC
cd ./cloudwan
aws cloudformation deploy \
  --region us-west-2\
  --stack-name "PDX-VPC-Blue" \
  --template-file "/home/ec2-user/environment/cloudwan/PDX-VPC-Blue.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM &&   
aws cloudformation deploy \
  --region us-west-2 \
  --stack-name "PDX-VPC-Green" \
  --template-file "/home/ec2-user/environment/cloudwan/PDX-VPC-Green.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

## FRT VPC ###
cd ./cloudwan
aws cloudformation deploy \
  --region eu-central-1\
  --stack-name "FRA-VPC-Blue" \
  --template-file "/home/ec2-user/environment/cloudwan/FRA-VPC-Blue.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM && \
aws cloudformation deploy \
  --region eu-central-1\
  --stack-name "FRA-VPC-Green" \
  --template-file "/home/ec2-user/environment/cloudwan/FRA-VPC-Green.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

## DUB VPC ###
cd ./cloudwan
aws cloudformation deploy \
  --region eu-west-1\
  --stack-name "DUB-VPC-Blue" \
  --template-file "/home/ec2-user/environment/cloudwan/DUB-VPC-Blue.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM && \
aws cloudformation deploy \
  --region eu-west-1\
  --stack-name "DUB-VPC-Green" \
  --template-file "/home/ec2-user/environment/cloudwan/DUB-VPC-Green.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

## corenetwork yaml deploy ##
aws cloudformation deploy \
  --region us-east-1 \
  --stack-name "CoreNetwork" \
  --template-file "/home/ec2-user/environment/cloudwan/CoreNetwork.yml" \
  --capabilities CAPABILITY_NAMED_IAM


## NRT VPC Routing Update ##
#aws cloudformation deploy \
#  --region ap-northeast-1 \
#  --stack-name "NRT-VPC-Blue-RT-Update" \
#  --template-file "/home/ec2-user/environment/cloudwan/NRT-VPC-Blue-RT-Update.yml" \
#  --capabilities CAPABILITY_NAMED_IAM

aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Blue-PublicRT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Blue-Private-Subnet-A-RT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Blue-Private-Subnet-B-RT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Green-PublicRT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Green-Private-Subnet-A-RT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Green-Private-Subnet-B-RT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId'

aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Blue-PublicRT' --region ap-southeast-2 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Blue-Private-Subnet-A-RT' --region ap-southeast-2 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Blue-Private-Subnet-B-RT' --region ap-southeast-2 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Green-PublicRT' --region ap-southeast-2 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Green-Private-Subnet-A-RT' --region ap-southeast-2 | jq -r '.RouteTables[].RouteTableId'
aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Green-Private-Subnet-B-RT' --region ap-southeast-2 | jq -r '.RouteTables[].RouteTableId'


export NRT_VPC_Blue_PublicRT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Blue-PublicRT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId')
export SYD_VPC_Blue_PublicRT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Blue-PublicRT' --region ap-southeast-1 | jq -r '.RouteTables[].RouteTableId')
export IAD_VPC_Blue_PublicRT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=IAD-VPC-Blue-PublicRT' --region us-east-1 | jq -r '.RouteTables[].RouteTableId')
export PDX_VPC_Blue_PublicRT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=PDX-VPC-Blue-PublicRT' --region us-west-2 | jq -r '.RouteTables[].RouteTableId')
export FRA_VPC_Blue_PublicRT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=FRA-VPC-Blue-PublicRT' --region eu-central-1 | jq -r '.RouteTables[].RouteTableId')
export DUB_VPC_Blue_PublicRT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=DUB-VPC-Blue-PublicRT' --region eu-west-1 | jq -r '.RouteTables[].RouteTableId')

export NRT_VPC_Blue_Private_Subnet_A_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Blue-Private-Subnet-A-RT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId')
export SYD_VPC_Blue_Private_Subnet_A_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Blue-Private-Subnet-A-RT' --region ap-southeast-1 | jq -r '.RouteTables[].RouteTableId')
export IAD_VPC_Blue_Private_Subnet_A_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=IAD-VPC-Blue-Private-Subnet-A-RT' --region us-east-1 | jq -r '.RouteTables[].RouteTableId')
export PDX_VPC_Blue_Private_Subnet_A_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=PDX-VPC-Blue--Private-Subnet-A-RT' --region us-west-2 | jq -r '.RouteTables[].RouteTableId')
export FRA_VPC_Blue_Private_Subnet_A_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=FRA-VPC-Blue-Private-Subnet-A-RT' --region eu-central-1 | jq -r '.RouteTables[].RouteTableId')
export DUB_VPC_Blue_Private_Subnet_A_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=DUB-VPC-Blue-Private-Subnet-A-RT' --region eu-west-1 | jq -r '.RouteTables[].RouteTableId')

export NRT_VPC_Blue_Private_Subnet_B_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=NRT-VPC-Private-Subnet-B-RT' --region ap-northeast-1 | jq -r '.RouteTables[].RouteTableId')
export SYD_VPC_Blue_Private_Subnet_B_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=SYD-VPC-Private-Subnet-B-RT' --region ap-southeast-1 | jq -r '.RouteTables[].RouteTableId')
export IAD_VPC_Blue_Private_Subnet_B_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=IAD-VPC-Private-Subnet-B-RT' --region us-east-1 | jq -r '.RouteTables[].RouteTableId')
export PDX_VPC_Blue_Private_Subnet_B_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=PDX-VPC-Private-Subnet-B-RT' --region us-west-2 | jq -r '.RouteTables[].RouteTableId')
export FRA_VPC_Blue_Private_Subnet_B_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=FRA-VPC-Private-Subnet-B-RT' --region eu-central-1 | jq -r '.RouteTables[].RouteTableId')
export DUB_VPC_Blue_Private_Subnet_B_RT_id=$(aws ec2 describe-route-tables --filters 'Name=tag:Name,Values=DUB-VPC-Private-Subnet-B-RT' --region eu-west-1 | jq -r '.RouteTables[].RouteTableId')

echo "export NRT_VPC_Blue_PublicRT_id=${NRT_VPC_Blue_PublicRT_id}"| tee -a ~/.bash_profile
echo "export SYD_VPC_Blue_PublicRT_id=${SYD_VPC_Blue_PublicRT_id}"| tee -a ~/.bash_profile
echo "export IAD_VPC_Blue_PublicRT_id=${IAD_VPC_Blue_PublicRT_id}"| tee -a ~/.bash_profile
echo "export PDX_VPC_Blue_PublicRT_id=${PDX_VPC_Blue_PublicRT_id}"| tee -a ~/.bash_profile
echo "export FRA_VPC_Blue_PublicRT_id=${FRA_VPC_Blue_PublicRT_id}"| tee -a ~/.bash_profile
echo "export DUB_VPC_Blue_PublicRT_id=${DUB_VPC_Blue_PublicRT_id}"| tee -a ~/.bash_profile

echo "export NRT_VPC_Blue_PublicRT_id=${NRT_VPC_Blue_Private_Subnet_A_RT_id}"| tee -a ~/.bash_profile
echo "export SYD_VPC_Blue_PublicRT_id=${SYD_VPC_Blue_Private_Subnet_A_RT_id}"| tee -a ~/.bash_profile
echo "export IAD_VPC_Blue_PublicRT_id=${IAD_VPC_Blue_Private_Subnet_A_RT_id}"| tee -a ~/.bash_profile
echo "export PDX_VPC_Blue_PublicRT_id=${PDX_VPC_Blue_Private_Subnet_A_RT_id}"| tee -a ~/.bash_profile
echo "export FRA_VPC_Blue_PublicRT_id=${FRA_VPC_Blue_Private_Subnet_A_RT_id}"| tee -a ~/.bash_profile
echo "export DUB_VPC_Blue_PublicRT_id=${DUB_VPC_Blue_Private_Subnet_A_RT_id}"| tee -a ~/.bash_profile

echo "export NRT_VPC_Blue_PublicRT_id=${NRT_VPC_Private_Subnet_B_RT_id}"| tee -a ~/.bash_profile
echo "export SYD_VPC_Blue_PublicRT_id=${SYD_VPC_Private_Subnet_B_RT_id}"| tee -a ~/.bash_profile
echo "export IAD_VPC_Blue_PublicRT_id=${IAD_VPC_Private_Subnet_B_RT_id}"| tee -a ~/.bash_profile
echo "export PDX_VPC_Blue_PublicRT_id=${PDX_VPC_Private_Subnet_B_RT_id}"| tee -a ~/.bash_profile
echo "export FRA_VPC_Blue_PublicRT_id=${FRA_VPC_Private_Subnet_B_RT_id}"| tee -a ~/.bash_profile
echo "export DUB_VPC_Blue_PublicRT_id=${DUB_VPC_Private_Subnet_B_RT_id}"| tee -a ~/.bash_profile

aws cloudformation describe-stacks --stack-name CoreNetwork --region us-east-1 | jq -r '.Stacks[].Outputs' | grep networkmanager

export core_network_arn='arn_output'
echo "export core_network_arn=${core_network_arn}" | tee -a ~/.bash_profile
export NRT_VPC_Blue_CIDR='10.21.0.0/16'
export SYD_VPC_Blue_CIDR='10.121.0.0/16'
export IAD_VPC_Blue_CIDR='10.31.0.0/16'
export PDX_VPC_Blue_CIDR='10.131.0.0/16'
export FRA_VPC_Blue_CIDR='10.41.0.0/16'
export DUB_VPC_Blue_CIDR='10.141.0.0/16'
echo "export NRT_VPC_Blue_CIDR=${NRT_VPC_Blue_CIDR}"| tee -a ~/.bash_profile
echo "export SYD_VPC_Blue_CIDR=${SYD_VPC_Blue_CIDR}"| tee -a ~/.bash_profile
echo "export IAD_VPC_Blue_CIDR=${IAD_VPC_Blue_CIDR}"| tee -a ~/.bash_profile
echo "export PDX_VPC_Blue_CIDR=${PDX_VPC_Blue_CIDR}"| tee -a ~/.bash_profile
echo "export FRA_VPC_Blue_CIDR=${FRA_VPC_Blue_CIDR}"| tee -a ~/.bash_profile
echo "export DUB_VPC_Blue_CIDR=${DUB_VPC_Blue_CIDR}"| tee -a ~/.bash_profile

export NRT_VPC_Green_CIDR='10.22.0.0/16'
export SYD_VPC_Green_CIDR='10.122.0.0/16'
export IAD_VPC_Green_CIDR='10.32.0.0/16'
export PDX_VPC_Green_CIDR='10.132.0.0/16'
export FRA_VPC_Green_CIDR='10.42.0.0/16'
export DUB_VPC_Green_CIDR='10.142.0.0/16'
echo "export NRT_VPC_Green_CIDR=${NRT_VPC_Green_CIDR}"| tee -a ~/.bash_profile
echo "export SYD_VPC_Green_CIDR=${SYD_VPC_Green_CIDR}"| tee -a ~/.bash_profile
echo "export IAD_VPC_Green_CIDR=${IAD_VPC_Green_CIDR}"| tee -a ~/.bash_profile
echo "export PDX_VPC_Green_CIDR=${PDX_VPC_Green_CIDR}"| tee -a ~/.bash_profile
echo "export FRA_VPC_Green_CIDR=${FRA_VPC_Green_CIDR}"| tee -a ~/.bash_profile
echo "export DUB_VPC_Green_CIDR=${DUB_VPC_Green_CIDR}"| tee -a ~/.bash_profile


aws ec2 create-route --region ap-northeast-1 --route-table-id $SYD_VPC_Blue_PublicRT_id --destination-cidr-block 10.121.0.0/16 --core-network-arn $core-network-arn



~/environment/useful-shell/aws_ec2_ext_nrt.sh | grep "Blue-Private" >> /home/ec2-user/environment/Blue-Private.txt
~/environment/useful-shell/aws_ec2_ext_iad.sh | grep "Blue-Private" >> /home/ec2-user/environment/Blue-Private.txt
~/environment/useful-shell/aws_ec2_ext_fra.sh | grep "Blue-Private" >> /home/ec2-user/environment/Blue-Private.txt

~/environment/useful-shell/aws_ec2_ext_nrt.sh | grep "Green-Private" >> /home/ec2-user/environment/Green-Private.txt
~/environment/useful-shell/aws_ec2_ext_iad.sh | grep "Green-Private" >> /home/ec2-user/environment/Green-Private.txt
~/environment/useful-shell/aws_ec2_ext_fra.sh | grep "Green-Private" >> /home/ec2-user/environment/Green-Private.txt

./aws_ec2_ext_nrt.sh | grep "Red-Private" >> /home/ec2-user/environment/Red-Private.txt
./aws_ec2_ext_iad.sh | grep "Red-Private" >> /home/ec2-user/environment/Red-Private.txt
./aws_ec2_ext_fra.sh | grep "Red-Private" >> /home/ec2-user/environment/Red-Private.txt

./aws_ec2_ext_nrt.sh | grep "Black-Private" >> /home/ec2-user/environment/Black-Private.txt
./aws_ec2_ext_iad.sh | grep "Black-Private" >> /home/ec2-user/environment/Black-Private.txt
./aws_ec2_ext_fra.sh | grep "Black-Private" >> /home/ec2-user/environment/Black-Private.txt

aws ssm start-session --target i-0b3ce905ab3e298c4 --region ap-northeast-1

aws cloudformation deploy \
  --region ap-northeast-2\
  --stack-name "Seoul-PRD" \
  --template-file "/home/ec2-user/environment/cloudwan/Seoul-VPC.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM


aws cloudformation deploy \
  --region ap-northeast-2\
  --stack-name "Seoul-VPN" \
  --template-file "/home/ec2-user/environment/cloudwan/Seoul-VPN.yml" \
  --parameter-overrides "KeyPair=$KeyName" \
  --capabilities CAPABILITY_NAMED_IAM

aws cloudformation deploy \
  --region us-east-1\
  --stack-name "CoreNetwork" \
  --template-file "/home/ec2-user/environment/cloudwan/CoreNetwork.yml"
